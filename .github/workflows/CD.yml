name: CD - Deploy Docker Compose

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'sudo -i -u deployuser bash -s' <<'EOF'
            set -e

            DEPLOY_DIR=/home/deployuser/my-docker
            BRANCH=main
            COMPOSE_FILE=$DEPLOY_DIR/docker-compose.dev.yml

            echo "==> نصب و چک کردن Git, Docker, Docker Compose ..."
            sudo apt update
            sudo apt install -y git ca-certificates curl gnupg lsb-release
            if ! command -v docker &> /dev/null; then
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt update
              sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            fi
            if ! docker compose version &> /dev/null; then
              sudo apt install -y docker-compose-plugin
            fi

            echo "==> آماده سازی repo ..."
            if [ ! -d "$DEPLOY_DIR" ]; then
              git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/zahidhamdard965/my-docker.git $DEPLOY_DIR
            fi
            cd $DEPLOY_DIR
            git fetch origin $BRANCH
            git reset --hard origin/$BRANCH

            echo "==> Pull آخرین images ..."
            DB_USER=${{ secrets.DB_USER }} \
            DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            DB_NAME=${{ secrets.DB_NAME }} \
            DB_HOST=db \
            DB_PORT=3306 \
            docker compose -f $COMPOSE_FILE pull

            echo "==> بالا آوردن سرویس‌ها ..."
            DB_USER=${{ secrets.DB_USER }} \
            DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            DB_NAME=${{ secrets.DB_NAME }} \
            DB_HOST=db \
            DB_PORT=3306 \
            docker compose -f $COMPOSE_FILE up -d

            echo "==> Deployment کامل شد ✅"
          EOF
