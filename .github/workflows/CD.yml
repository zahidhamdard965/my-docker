name: CD - Deploy Docker Compose

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'bash -s' <<'EOF'
            set -e

            DEPLOY_DIR=~/my-docker
            BRANCH=main
            COMPOSE_FILE=docker-compose.dev.yml

            echo "==> چک کردن Git ..."
            if ! command -v git &> /dev/null; then
              sudo apt update
              sudo apt install -y git
            fi

            echo "==> چک کردن Docker ..."
            if ! command -v docker &> /dev/null; then
              sudo apt update
              sudo apt install -y ca-certificates curl gnupg lsb-release
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt update
              sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            fi

            echo "==> چک کردن Docker Compose ..."
            if ! docker compose version &> /dev/null; then
              sudo apt update
              sudo apt install -y docker-compose-plugin
            fi

            echo "==> ایجاد کاربر جدید ..."
            USERNAME="devuser_$(date +%s)"
            sudo adduser --disabled-password --gecos "Dev User,,," $USERNAME || true
            sudo -u $USERNAME git config --global user.name "$USERNAME"
            sudo -u $USERNAME git config --global user.email "$USERNAME@example.com"
            sudo usermod -aG docker $USERNAME || true

            echo "==> آماده سازی repo ..."
            if [ ! -d "$DEPLOY_DIR" ]; then
              git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/zahidhamdard965/my-docker.git $DEPLOY_DIR
            fi
            cd $DEPLOY_DIR
            git fetch origin $BRANCH
            git reset --hard origin/$BRANCH

            echo "==> تنظیم متغیرهای محیطی ..."
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export DB_HOST=db
            export DB_PORT=3306

            echo "==> Pull آخرین images ..."
            sudo docker compose -f $COMPOSE_FILE pull

            echo "==> بالا آوردن سرویس‌ها ..."
            sudo docker compose -f $COMPOSE_FILE up -d

            echo "==> Deployment کامل شد ✅"
          EOF
